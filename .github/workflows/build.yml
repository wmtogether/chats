name: Build and Test Miko Workspace

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
        
    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-
          
    - name: Install Node.js dependencies
      run: bun install
      
    - name: Check Rust formatting
      run: cargo fmt --all -- --check
      working-directory: Desktop
      
    - name: Run Rust clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
      working-directory: Desktop
      
    - name: Run Rust tests
      run: cargo test --verbose
      working-directory: Desktop
      
    - name: Check TypeScript types
      run: bun run tsc --noEmit
      
    - name: Build frontend
      run: bun run build

  build:
    name: Build Application
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
        
    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-
          
    - name: Install Node.js dependencies
      run: bun install
      
    - name: Build application
      run: bun run build
      
    - name: Verify build artifacts
      run: |
        if (!(Test-Path "Distribution\Package\mikochat.exe")) { 
          Write-Error "mikochat.exe not found in Distribution\Package" 
          exit 1 
        }
        if (!(Test-Path "Distribution\Package\mikoproxy.exe")) { 
          Write-Error "mikoproxy.exe not found in Distribution\Package" 
          exit 1 
        }
        if (!(Test-Path "Distribution\Package\msedgewebview2.exe")) { 
          Write-Error "WebView2 runtime not found in Distribution\Package" 
          exit 1 
        }
        Write-Host "‚úÖ All build artifacts verified successfully"
      shell: powershell
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: miko-workspace-build
        path: |
          Distribution/Package/
          !Distribution/Package/**/*.pdb
        retention-days: 30

  build-installer:
    name: Build Installer
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
        
    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-
          
    - name: Install Node.js dependencies
      run: bun install
      
    - name: Build application
      run: bun run build
      
    - name: Setup Inno Setup
      run: |
        $url = "https://jrsoftware.org/download.php/is.exe"
        $output = "$env:TEMP\innosetup.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        # Add Inno Setup to PATH
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6"
        if (Test-Path $innoPath) {
          echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
      shell: powershell
      
    - name: Build installer
      run: bun run build-installer
      
    - name: Verify installer
      run: |
        if (!(Test-Path "Distribution\MikoWorkspaceSetup.exe")) { 
          Write-Error "Installer not found in Distribution directory" 
          exit 1 
        }
        $fileInfo = Get-Item "Distribution\MikoWorkspaceSetup.exe"
        Write-Host "‚úÖ Installer created successfully: $($fileInfo.Name) ($($fileInfo.Length) bytes)"
      shell: powershell
      
    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: miko-workspace-installer
        path: Distribution/MikoWorkspaceSetup.exe
        retention-days: 90

  release:
    name: Create Release
    runs-on: windows-latest
    needs: [build, build-installer]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download installer artifact
      uses: actions/download-artifact@v4
      with:
        name: miko-workspace-installer
        path: ./release/
        
    - name: Get version from Cargo.toml
      id: version
      run: |
        $version = (Select-String -Path "Desktop\Cargo.toml" -Pattern 'version = "(.+)"').Matches[0].Groups[1].Value
        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        echo "tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      shell: powershell
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Miko Workspace ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          ./release/MikoWorkspaceSetup.exe
        body: |
          ## Miko Workspace ${{ steps.version.outputs.version }}
          
          ### üöÄ Features
          - Modern desktop chat application
          - Native Windows integration with Win32 menus
          - Bundled WebView2 runtime for consistent experience
          - Authentication proxy for secure API communication
          
          ### üì¶ Installation
          Download and run `MikoWorkspaceSetup.exe` to install Miko Workspace.
          
          The application will be installed to: `%LOCALAPPDATA%\Miko\Workspace`
          
          ### üîß System Requirements
          - Windows 10 version 1809 or later
          - x64 architecture
          
          ### üìù Changes
          See the commit history for detailed changes in this release.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}